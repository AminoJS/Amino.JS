<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @name Kikai Framework
 * @author RobStyling
 * @version 0.0.0
 * @copyright RobStyling 2018
 * @beta
 */

const request = require('request-promise');
const endpoints = require('./endpoints.js');
const sorter = require('./sorter.js');
const objs = require('./objects.js');

module.exports = {
    /**
     * Loginfunction for the Framework for Handeling API Reqeusts.
     * @param  {String} email    Email-Adresse für den Login
     * @param  {String} password Passwort für den Login
     * @param  {UUID} deviceID Siehe mehr unter ('howto/deviceid_dump.md')
     * @return {SecurityString} sid      Der Security String um mit der API zu komunizieren.
     */
    login: async function(email, password, deviceID) {
        let sid;
        await request.post(endpoints.login, {
            json: {
                "email": email,
                "secret": "0 " + password,
                "deviceID": deviceID,
                "clientType": 100,
                "action": "normal",
                "timestamp": new Date().getUTCMilliseconds()
            }
        }, (err, res, body) => {
            if (err) throw 'Request Error: ' + err;
            if (!body.sid) throw 'Login Error: SID is not defined.' + res;
            sid = body.sid;
        }).catch((err) => {
            throw 'Error while calling Login: ' + err;
        });
        return sid;
    },

    getJoinedComs: async function(sid) {
        let communityList = objs.communityList;
        await request.get(endpoints.getComs, {
            headers: {
                'NDCAUTH': `sid=${sid}`
            }
        }, (err, res, body) => {
            try {
                if (err) throw 'Request Error: ' + err;
                body = JSON.parse(body);
                body.communityList.forEach((element) => {
                    communityList.coms.push(sorter.comSort(element));
                })
                communityList.status = "ok";
                communityList.error = null;
            } catch (err) {
                communityList.error = err;
            }
        })
        return communityList;
    },


    getJoinedChats: async function(sid, com) {
        let threadList = objs.threadList;
        await request.get(endpoints.getJoinedChats(com), {
            headers: {
                'NDCAUTH': `sid=${sid}`
            }
        }, (err, res, body) => {
            try {
                body = JSON.parse(body);
                body.threadList.forEach((element) => {
                    publicChat = sorter.publicChat(element.type);
                    group = sorter.groupChat(element.type);
                    joined = sorter.didJoin(element.membershipStatus);
                    muted = sorter.didMute(element.alertOption);
                    unread = sorter.didUnread(element.condition);
                    threadList.threads.push(sorter.threadSort(element, joined, publicChat, group, muted, unread));
                })
                threadList.status = "ok";
                threadList.error = null;
            } catch (err) {
                threadList.error = err;
                console.log(threadList);
            }
        })
        return threadList;
    },

    getChat: async function(sid, com, uid, count) {
        let msgList = objs.recivedMessages;
        try {
            await request.get(endpoints.loadChat(com, uid, count), {
                headers: {
                    'NDCAUTH': `sid=${sid}`
                }
            }, (err, res, body) => {
                body = JSON.parse(body);
                console.log(body);
            });
            msgList.status = 'ok';
            msgList.error = null;
        }
        catch(err) {
            msgList.error = err;
        }
        return msgList
    },

    sendChat: async function(sid, com, uid, msg) {
        let message = objs.sendingMessage;
        message.message.message = msg;
        message.message.threadId = uid;
        try {
            await request.post(endpoints.sendChat(com, uid), {
                headers: {
                    'NDCAUTH': `sid=${sid}`
                },
                json: {
                    'content': msg,
                    'type': 0,
                    'clientRefId': 43196704,
                    'timestamp': new Date().getUTCMilliseconds()
                }
            }, (err, res, body) => {
                if (body.message) {
                    message.message.sent = true;
                    message.status = 'ok';
                    message.error = null;
                }
            })
        } catch (err) {
            message.error = err;
        }
        return message;
    }
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#KikaiFramework">Kikai Framework</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Sun Feb 04 2018 11:40:51 GMT+0100 (Mitteleuropäische Zeit)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
